<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <LangVersion>latest</LangVersion>
    <VelloRuntimeIdentifier>$(RuntimeIdentifier)</VelloRuntimeIdentifier>
    <VelloRepositoryRoot>$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)..\..\'))</VelloRepositoryRoot>
    <IsPackable>true</IsPackable>
    <PackageId>VelloSharp</PackageId>
    <Title>VelloSharp</Title>
    <Description>.NET bindings for the Vello renderer with native runtime resolution.</Description>
    <PackageOutputPath Condition="'$(PackageOutputPath)'==''">$([System.IO.Path]::Combine('$(VelloRepositoryRoot)', 'artifacts', 'nuget'))</PackageOutputPath>
    <PublishRepositoryUrl>true</PublishRepositoryUrl>
    <EmbedUntrackedSources>true</EmbedUntrackedSources>
    <VelloNativeAssetsDirectory Condition="'$(VelloNativeAssetsDirectory)'==''">$([System.IO.Path]::Combine('$(OutputPath)', 'runtimes'))</VelloNativeAssetsDirectory>
    <VelloNativeAssetsDirectory>$([MSBuild]::EnsureTrailingSlash('$(VelloNativeAssetsDirectory)'))</VelloNativeAssetsDirectory>
    <VelloRequireAllNativeAssets Condition="'$(VelloRequireAllNativeAssets)'==''">true</VelloRequireAllNativeAssets>
    <VelloSkipNativeBuild Condition="'$(VelloSkipNativeBuild)'==''">false</VelloSkipNativeBuild>
    <VelloIncludeNativeAssets Condition="'$(VelloIncludeNativeAssets)'==''">true</VelloIncludeNativeAssets>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.SourceLink.GitHub" PrivateAssets="All" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="../VelloSharp.Ffi.Core/VelloSharp.Ffi.Core.csproj" />
    <ProjectReference Include="../VelloSharp.Ffi.Sparse/VelloSharp.Ffi.Sparse.csproj" />
    <ProjectReference Include="../VelloSharp.Ffi.Gpu/VelloSharp.Ffi.Gpu.csproj" />
    <ProjectReference Include="../VelloSharp.Core/VelloSharp.Core.csproj" />
  </ItemGroup>

  <ItemGroup Condition="'$(IsPackable)' == 'true' and '$(VelloIncludeNativeAssets)' == 'true' and Exists('$(VelloNativeAssetsDirectory)')">
    <Content Include="$(VelloNativeAssetsDirectory)**/*"
             Pack="true"
             PackagePath="runtimes/%(RecursiveDir)%(Filename)%(Extension)"
             Visible="false">
      <VelloNativeAsset>true</VelloNativeAsset>
    </Content>
  </ItemGroup>

  <Target Name="EnsureVelloNativeAssets"
          BeforeTargets="Pack"
          Condition="'$(IsPackable)' == 'true' and '$(VelloIncludeNativeAssets)' == 'true' and '$(VelloRequireAllNativeAssets)' == 'true'">
    <ItemGroup>
      <_VelloNativeContent Include="@(Content)"
                           Condition="'%(VelloNativeAsset)' == 'true'" />
    </ItemGroup>
    <Error Condition="'@(_VelloNativeContent)' == ''"
           Text="Vello native assets were not found in '$(VelloNativeAssetsDirectory)'. Provide platform builds or set VelloRequireAllNativeAssets=false." />
  </Target>

  <UsingTask TaskName="GetCurrentRid"
             TaskFactory="RoslynCodeTaskFactory"
             AssemblyName="Microsoft.Build.Tasks.Core">
    <ParameterGroup>
      <RuntimeIdentifier ParameterType="System.String" Output="true" />
    </ParameterGroup>
    <Task>
      <Code Type="Fragment" Language="cs"><![CDATA[
var info = new System.Diagnostics.ProcessStartInfo("dotnet", "--info")
{
    RedirectStandardOutput = true,
    RedirectStandardError = true,
    UseShellExecute = false,
    CreateNoWindow = true,
};

using var process = System.Diagnostics.Process.Start(info);
if (process is null)
{
    throw new System.InvalidOperationException("Failed to start 'dotnet --info'.");
}

var output = process.StandardOutput.ReadToEnd();
process.WaitForExit();

var rid = string.Empty;
using (var reader = new System.IO.StringReader(output))
{
    string line;
    while ((line = reader.ReadLine()) is not null)
    {
        line = line.Trim();
        if (line.StartsWith("RID:", System.StringComparison.OrdinalIgnoreCase))
        {
            var colon = line.IndexOf(':');
            if (colon >= 0 && colon + 1 < line.Length)
            {
                rid = line.Substring(colon + 1).Trim();
            }
            break;
        }
    }
}

RuntimeIdentifier = rid;
]]></Code>
    </Task>
  </UsingTask>

  <Target Name="EnsureVelloRuntimeIdentifier"
          BeforeTargets="Build"
          Condition="'$(DesignTimeBuild)' != 'true'">
    <PropertyGroup>
      <VelloRuntimeIdentifier Condition="'$(VelloRuntimeIdentifier)'=='' and '$(RuntimeIdentifier)'!=''">$(RuntimeIdentifier)</VelloRuntimeIdentifier>
      <VelloRuntimeIdentifier Condition="'$(VelloRuntimeIdentifier)'=='' and '$(ResolvedCurrentRuntimeIdentifier)'!=''">$(ResolvedCurrentRuntimeIdentifier)</VelloRuntimeIdentifier>
      <VelloRuntimeIdentifier Condition="'$(VelloRuntimeIdentifier)'=='' and '$(MSBuildRuntimeIdentifier)'!=''">$(MSBuildRuntimeIdentifier)</VelloRuntimeIdentifier>
    </PropertyGroup>
    <GetCurrentRid Condition="'$(VelloRuntimeIdentifier)'==''">
      <Output TaskParameter="RuntimeIdentifier" PropertyName="VelloRuntimeIdentifier" />
    </GetCurrentRid>
    <PropertyGroup>
      <VelloRuntimeIdentifier Condition="'$(VelloRuntimeIdentifier)'==''">unknown</VelloRuntimeIdentifier>
    </PropertyGroup>
  </Target>

  <Target Name="BuildVelloNativeLibrary"
          DependsOnTargets="EnsureVelloRuntimeIdentifier"
          BeforeTargets="Build"
          Condition="'$(DesignTimeBuild)' != 'true' and '$(VelloRuntimeIdentifier)' != 'unknown' and '$(VelloSkipNativeBuild)' != 'true'">
    <ItemGroup>
      <_VelloNativeManifest Include="$(MSBuildThisFileDirectory)..\..\ffi\*\Cargo.toml">
        <CrateName Condition="Exists('%(Identity)')">$([System.IO.Path]::GetFileName($([System.IO.Path]::GetDirectoryName('%(Identity)'))))</CrateName>
      </_VelloNativeManifest>
    </ItemGroup>

    <ItemGroup>
      <_VelloNativeManifest Remove="@(_VelloNativeManifest)" Condition="'%(_VelloNativeManifest.CrateName)' == ''" />
    </ItemGroup>

    <ItemGroup>
      <_VelloNativeCrate Include="@(_VelloNativeManifest->'%(CrateName)')" />
    </ItemGroup>

    <ItemGroup Condition="'@(_VelloNativeCrate)' == ''">
      <_VelloNativeCrate Include="accesskit_ffi" />
      <_VelloNativeCrate Include="vello_ffi" />
      <_VelloNativeCrate Include="kurbo_ffi" />
      <_VelloNativeCrate Include="peniko_ffi" />
      <_VelloNativeCrate Include="winit_ffi" />
    </ItemGroup>

    <PropertyGroup>
      <_VelloNativePrefix>lib</_VelloNativePrefix>
      <_VelloNativePrefix Condition="'$(VelloRuntimeIdentifier)' == 'win-x64' or '$(VelloRuntimeIdentifier)' == 'win-arm64' or '$(VelloRuntimeIdentifier)' == 'win'"></_VelloNativePrefix>
      <_VelloNativeSuffix>.so</_VelloNativeSuffix>
      <_VelloNativeSuffix Condition="'$(VelloRuntimeIdentifier)' == 'win-x64' or '$(VelloRuntimeIdentifier)' == 'win-arm64' or '$(VelloRuntimeIdentifier)' == 'win'">.dll</_VelloNativeSuffix>
      <_VelloNativeSuffix Condition="'$(VelloRuntimeIdentifier)' == 'osx-x64' or '$(VelloRuntimeIdentifier)' == 'osx-arm64' or '$(VelloRuntimeIdentifier)' == 'osx'">.dylib</_VelloNativeSuffix>

      <_VelloRustTarget Condition="'$(VelloRuntimeIdentifier)' == 'win-x64'">x86_64-pc-windows-msvc</_VelloRustTarget>
      <_VelloRustTarget Condition="'$(VelloRuntimeIdentifier)' == 'win-arm64'">aarch64-pc-windows-msvc</_VelloRustTarget>
      <_VelloRustTarget Condition="'$(VelloRuntimeIdentifier)' == 'osx-x64'">x86_64-apple-darwin</_VelloRustTarget>
      <_VelloRustTarget Condition="'$(VelloRuntimeIdentifier)' == 'osx-arm64'">aarch64-apple-darwin</_VelloRustTarget>
      <_VelloRustTarget Condition="'$(VelloRuntimeIdentifier)' == 'linux-x64'">x86_64-unknown-linux-gnu</_VelloRustTarget>
      <_VelloRustTarget Condition="'$(VelloRuntimeIdentifier)' == 'linux-arm64'">aarch64-unknown-linux-gnu</_VelloRustTarget>

      <_VelloCargoProfileFlag Condition="'$(Configuration)'=='Debug'"></_VelloCargoProfileFlag>
      <_VelloCargoProfileFlag Condition="'$(Configuration)'!='Debug'">--release</_VelloCargoProfileFlag>
      <_VelloCargoProfileDir Condition="'$(Configuration)'=='Debug'">debug</_VelloCargoProfileDir>
      <_VelloCargoProfileDir Condition="'$(Configuration)'!='Debug'">release</_VelloCargoProfileDir>
    </PropertyGroup>

    <ItemGroup>
      <_VelloNativeCrate Update="@(_VelloNativeCrate)">
        <NativeFileName>$(_VelloNativePrefix)%(Identity)$(_VelloNativeSuffix)</NativeFileName>
      </_VelloNativeCrate>
    </ItemGroup>

    <Exec Command="cargo build -p %(_VelloNativeCrate.Identity) --target $(_VelloRustTarget) $(_VelloCargoProfileFlag)"
          WorkingDirectory="$(VelloRepositoryRoot)"
          Condition="'$(_VelloRustTarget)' != ''" />
    <Exec Command="cargo build -p %(_VelloNativeCrate.Identity) $(_VelloCargoProfileFlag)"
          WorkingDirectory="$(VelloRepositoryRoot)"
          Condition="'$(_VelloRustTarget)' == ''" />

    <PropertyGroup>
      <_VelloCargoOutputDir Condition="'$(_VelloRustTarget)' == ''">$([System.IO.Path]::Combine('$(VelloRepositoryRoot)', 'target', '$(_VelloCargoProfileDir)'))</_VelloCargoOutputDir>
      <_VelloCargoOutputDir Condition="'$(_VelloRustTarget)' != ''">$([System.IO.Path]::Combine('$(VelloRepositoryRoot)', 'target', '$(_VelloRustTarget)', '$(_VelloCargoProfileDir)'))</_VelloCargoOutputDir>
      <_VelloRuntimeNativeDir>$([System.IO.Path]::Combine('$(OutDir)', 'runtimes', '$(VelloRuntimeIdentifier)', 'native'))</_VelloRuntimeNativeDir>
    </PropertyGroup>

    <ItemGroup>
      <_VelloNativeCrate Update="@(_VelloNativeCrate)">
        <SourcePath>$([System.IO.Path]::Combine('$(_VelloCargoOutputDir)', '%(NativeFileName)'))</SourcePath>
        <RuntimePath>$([System.IO.Path]::Combine('$(_VelloRuntimeNativeDir)', '%(NativeFileName)'))</RuntimePath>
        <OutputPath>$([System.IO.Path]::Combine('$(OutDir)', '%(NativeFileName)'))</OutputPath>
      </_VelloNativeCrate>
    </ItemGroup>

    <Error Condition="!Exists('%(_VelloNativeCrate.SourcePath)')"
           Text="The native library '%(_VelloNativeCrate.NativeFileName)' was not produced at '%(_VelloNativeCrate.SourcePath)'. Ensure the Rust toolchain for '$(VelloRuntimeIdentifier)' is installed." />

    <Copy SourceFiles="%(_VelloNativeCrate.SourcePath)"
          DestinationFiles="%(_VelloNativeCrate.RuntimePath)"
          SkipUnchangedFiles="true" />

    <Copy SourceFiles="%(_VelloNativeCrate.SourcePath)"
          DestinationFiles="%(_VelloNativeCrate.OutputPath)"
          SkipUnchangedFiles="true" />
  </Target>
  <Target Name="CollectVelloNativeAssets" AfterTargets="Build">
    <ItemGroup>
      <ReferenceCopyLocalPaths Include="$(OutDir)runtimes\**\*">
        <DestinationSubDirectory>%(RecursiveDir)</DestinationSubDirectory>
      </ReferenceCopyLocalPaths>
      <ReferenceCopyLocalPaths Include="$(OutDir)runtimes\**\*.dll">
        <DestinationSubDirectory></DestinationSubDirectory>
      </ReferenceCopyLocalPaths>
    </ItemGroup>
  </Target>
</Project>
